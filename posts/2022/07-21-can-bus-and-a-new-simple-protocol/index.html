<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.103.0"><link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/dsrkafuu/dsr-cdn@1/images/favicons/dsrca/favicon.ico><title>CAN Bus and a New Simple Protocol - technical_</title><meta name=author content="Andrei Gramakov"><meta name=keywords content="zakhar,robotics,canbus,i2c,protocol,interface"><meta property="og:title" content="CAN Bus and a New Simple Protocol"><meta name=twitter:title content="CAN Bus and a New Simple Protocol"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.agramakov.me/posts/2022/07-21-can-bus-and-a-new-simple-protocol/"><meta property="og:description" content="Not Only Two Wires
It’s been more than two years already since I started working on my robot Zakhar. The Zakhar 1 was built out of Lego and relied on I2C communication between modules. It was a nightmare because as it turned out each MCU developer has its own understanding of how a developer should interact with the I2C unit. What I wanted from the interface:"><meta name=twitter:description content="Not Only Two Wires
It’s been more than two years already since I started working on my robot Zakhar. The Zakhar 1 was built out of Lego and relied on I2C communication between modules. It was a nightmare because as it turned out each MCU developer has its own understanding of how a developer should interact with the I2C unit. What I wanted from the interface:"><meta name=twitter:card content="summary"><meta property="article:published_time" content="2022-07-21T20:28:27+01:00"><meta property="article:modified_time" content="2022-07-21T20:28:27+01:00"><link rel=stylesheet href=https://blog.agramakov.me/assets/css/fuji.min.css></head><body data-theme=auto><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://blog.agramakov.me>technical_</a></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://blog.agramakov.me/posts/2022/07-21-can-bus-and-a-new-simple-protocol/>CAN Bus and a New Simple Protocol</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-07-21</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/zakhar>zakhar</a>&nbsp;<a href=/tags/robotics>robotics</a>&nbsp;<a href=/tags/canbus>canbus</a>&nbsp;<a href=/tags/i2c>i2c</a>&nbsp;<a href=/tags/protocol>protocol</a>&nbsp;<a href=/tags/interface>interface</a>&nbsp;</span></div><div class="post-content markdown-body"><h2 id=not-only-two-wires>Not Only Two Wires</h2><p>It’s been more than two years already since I started working on my robot Zakhar. The Zakhar 1 was built out of Lego and relied on I2C communication between modules. It was a nightmare because as it turned out each MCU developer has its own understanding of how a developer should interact with the I2C unit. What I wanted from the interface:</p><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/Untitled.png alt="I2C makes robots sad"></p><ul><li>Main/secondary nodes interaction</li><li>Understand what devices are in the network</li><li>Send commands</li><li>Receive sensor data</li></ul><p>To make all this possible I’ve developed a simple I2C-based protocol but couldn’t get the desired behavior (read more in <a href=https://hackaday.io/project/171888-zakhar-the-robot/log/196935-dear-i2c-i-resemble target=_blank>my post</a>) on all platforms - Raspberry Pi, STM32, Arduino, and ESP32. Overly Zakhar 1 had too many problems to continue the project - mechanically it was floppy, power sources were unstable, the display was flickering, and the interface… It was too distracting, unstable, and annoying to continue!</p><p>I started Zakhar 2 based on the CAN interface. Why CAN? There are many advantages of CAN compared to I2C:</p><ul><li>Better MCU developer support</li><li>A single data frame contains much more information than I2C</li><li>Physical layer - actually not specified, but de-facto it is RS485 and it is much suitable for heterogeneous systems with several power sources:<ul><li>Really two-wires interface, without a common ground</li><li>No voltage levels shifters</li></ul></li><li>Embedded addressing mechanism</li><li>Still simple</li></ul><p>There are cons of course. The main one is that not all platforms have hardware CAN bus support. But there are many external modules on the market, there are tons of drivers developed for all platforms, and there are thousands of guides written, so it is easy to mitigate.</p><h2 id=yes-a-new-protocol>Yes, a new protocol!</h2><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/Untitled%201.png alt="CAN is used in vehicles and has many flavors"></p><p>I like developing standards. I really wanted to invent my own bicycle. Also, I wanted to make a transition from I2C to CAN smooth keeping all implemented features and continuing established directions. And likely for Zakhar 2, there was no good candidate. Had no reason not to develop my own CAN-based protocol. Here is not the full list of my options with the main reason to say no:</p><ul><li><a href=https://en.wikipedia.org/wiki/CANopen target=_blank>CANopen</a> - too complex</li><li><a href=https://en.wikipedia.org/wiki/DeviceNet target=_blank>DeviceNet</a> - CIP, not needed (hello my employer!)</li><li><a href=https://en.wikipedia.org/wiki/SAE_J1939 target=_blank>SAE_J1939</a> - too complex</li><li><a href=https://en.wikipedia.org/wiki/CANaerospace target=_blank>CANaerospace</a> - too complex</li><li><a href=https://en.wikipedia.org/wiki/Cubesat_Space_Protocol target=_blank>Cubesat_Space_Protocol</a> - better, good support, but excessive</li><li><a href=https://en.wikipedia.org/wiki/Very_Simple_Control_Protocol target=_blank>Very_Simple_Control_Protocol</a> - not <strong>very</strong> simple</li></ul><h2 id=the-bicycle>The Bicycle</h2><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/Untitled%202.png alt="Old Bicycle"></p><p>It is turned out, that I don’t need to build a lot on top of bare CAN. The protocol is based on the usage of the ID field of the CAN frame. The field carries all the necessary information for the protocol. Here are some illustrations for the Standard and the Extended CAN frame (my know-how is in green):</p><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/canbus_frame_std.svg alt="Standard Frame"></p><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/canbus_frame_ext.svg alt="Extended Frame"></p><p>Each device has its own address, an ID. Information about the source, the destination, and the message type is embedded info the ID filed in a way that makes it simple to read by a human in HEX format. For example, if the device with the id #5 sends a message of type 1 to device #3, the message ID will be <strong>0x531</strong> and <strong>0x0503001</strong> for the standard and the extended frames respectively.</p><p>Since CAN bus devices by default are constantly sending data in the network I used it for device discovery. All devices should send a Presence message at least once in 3 seconds. If not, the device is considered disconnected.</p><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/Untitled%203.png alt="Presence Messages"></p><p>With such a message structure, it is very simple to address commands not only to a specific device but also to broadcast them using the destination of 0x0. Also sending data information can be broadcasted as well as dedicated to a specific device:</p><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/Untitled%204.png alt=Commands></p><p>Commands</p><p><img class=img-zoomable src=CAN%20bus%20and%20a%20new%20simple%20protocol%20b5025925c93f493abf97425c9879981d/Untitled%205.png alt="Data Messages"></p><p>Data Messages</p><p>The full protocol description is available on the Zakhar documentation page here:</p><p><a href=https://zakhar-the-robot.github.io/doc/docs/communication-protocols/canbus/ target=_blank>https://zakhar-the-robot.github.io/doc/docs/communication-protocols/canbus/</a></p><h2 id=whats-next>What’s Next?</h2><p>I’m finishing the firmware implementation for all my robot units. In the next article, I want to talk about the <strong>protocol implementation in the Zakhar the Robot project</strong>.</p><h2 id=nice-but-whats-about-the-alive-robot>Nice but What’s About the Alive Robot?</h2><p>The main purpose of the project is to investigate the potential of animal-like behavior for the human-robot interaction. It is a big sophisticated topic and working on this demands a reliable hardware basis. I plan to spend some more time working on this. Then I will return to the high-level problem. Also, as I am a low-level developer I know that the hardware architecture defines high-level possibilities so it is important to make it right. Thanks for your patience and stay tuned!</p><h2 id=links>Links</h2><ul><li><a href=https://blog.agramakov.me/ target=_blank>My blog</a></li><li><a href=https://zakhar-the-robot.github.io/doc/docs/communication-protocols/canbus/ target=_blank>Standard Documentation</a></li><li><a href=https://www.facebook.com/groups/zakhartherobot target=_blank>Facebook</a></li><li><a href=https://www.instagram.com/zakhar_the_robot target=_blank>Instagram</a></li><li><a href=https://hackaday.io/project/171888-zakhar-the-robot target=_blank>Hackaday.io project page</a></li></ul></div></article><style>#share-buttons{display:inline-block;vertical-align:middle}#share-buttons:after{content:"";display:block;clear:both}#share-buttons>div{position:relative;text-align:left;height:36px;width:32px;float:left;text-align:center}#share-buttons>div>svg{height:16px;fill:#d5d5d5;margin-top:10px}#share-buttons>div:hover{cursor:pointer}#share-buttons>div.facebook:hover>svg{fill:#3b5998}#share-buttons>div.twitter:hover>svg{fill:#55acee}#share-buttons>div.linkedin:hover>svg{fill:#0077b5}#share-buttons>div.pinterest:hover>svg{fill:#cb2027}#share-buttons>div.mail:hover>svg{fill:#7d7d7d}#share-buttons>div.facebook>svg{height:18px;margin-top:9px}#share-buttons>div.twitter>svg{height:20px;margin-top:8px}#share-buttons>div.linkedin>svg{height:19px;margin-top:7px}#share-buttons>div.pinterest>svg{height:20px;margin-top:9px}#share-buttons>div.mail>svg{height:14px;margin-top:11px}</style><span style=color:silver>Share on:</span><div id=share-buttons><div class=facebook title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=https://blog.agramakov.me/posts/2022/07-21-can-bus-and-a-new-simple-protocol/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div><div class=twitter title="Share this on Twitter" onclick='window.open("http://twitter.com/intent/tweet?text=CAN Bus and a New Simple Protocol&url=https://blog.agramakov.me/posts/2022/07-21-can-bus-and-a-new-simple-protocol/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class=linkedin title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=https://blog.agramakov.me/posts/2022/07-21-can-bus-and-a-new-simple-protocol/&title=&summary=&source=")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div><div class=mail title="Share this through Email" onclick='window.open("mailto:?&body=https://blog.agramakov.me/posts/2022/07-21-can-bus-and-a-new-simple-protocol/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=https://blog.agramakov.me>main page</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://agramakov.me target=_blank><span>About me</span></a></li><li><a href=https://github.com/an-dr/blog_technical target=_blank><span>blog_technical@github</span></a></li><li><a href=https://zakhar.agramakov.me target=_blank><span>Zakhar on hackaday.io</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Categories</h3><div><li><a href=https://blog.agramakov.me/categories/articles>articles</a></li><li><a href=https://blog.agramakov.me/categories/codding>codding</a></li><li><a href=https://blog.agramakov.me/categories/linux>linux</a></li><li><a href=https://blog.agramakov.me/categories/opencv>opencv</a></li><li><a href=https://blog.agramakov.me/categories/raspberry>raspberry</a></li><li><a href=https://blog.agramakov.me/categories/robotics>robotics</a></li><li><a href=https://blog.agramakov.me/categories/ros>ros</a></li><li><a href=https://blog.agramakov.me/categories/virtualization>virtualization</a></li><li><a href=https://blog.agramakov.me/categories/zakhar>zakhar</a></li></div></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/aliveos/>aliveos</a></span>
<span><a href=/tags/articles/>articles</a></span>
<span><a href=/tags/build/>build</a></span>
<span><a href=/tags/canbus/>canbus</a></span>
<span><a href=/tags/cpp/>cpp</a></span>
<span><a href=/tags/display/>display</a></span>
<span><a href=/tags/diy/>diy</a></span>
<span><a href=/tags/eclipse/>eclipse</a></span>
<span><a href=/tags/embedded/>embedded</a></span>
<span><a href=/tags/emotions/>emotions</a></span>
<span><a href=/tags/hackaday/>hackaday</a></span>
<span><a href=/tags/hardware/>hardware</a></span>
<span><a href=/tags/howto/>howto</a></span>
<span><a href=/tags/i2c/>i2c</a></span>
<span><a href=/tags/interface/>interface</a></span>
<span><a href=/tags/linux/>linux</a></span>
<span><a href=/tags/mechanics/>mechanics</a></span>
<span><a href=/tags/motors/>motors</a></span>
<span><a href=/tags/opencv/>opencv</a></span>
<span><a href=/tags/protocol/>protocol</a></span>
<span><a href=/tags/prototyping/>prototyping</a></span>
<span><a href=/tags/raspberry/>raspberry</a></span>
<span><a href=/tags/research/>research</a></span>
<span><a href=/tags/robot/>robot</a></span>
<span><a href=/tags/robotics/>robotics</a></span>
<span><a href=/tags/ros/>ros</a></span>
<span><a href=/tags/stm32/>stm32</a></span>
<span><a href=/tags/uart/>uart</a></span>
<span><a href=/tags/visualstudio/>visualstudio</a></span>
<span><a href=/tags/zakhar/>zakhar</a></span>
<span><a href=/tags/zeromq/>zeromq</a></span>
<span><a href=/tags/zmq/>zmq</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#not-only-two-wires>Not Only Two Wires</a></li><li><a href=#yes-a-new-protocol>Yes, a new protocol!</a></li><li><a href=#the-bicycle>The Bicycle</a></li><li><a href=#whats-next>What’s Next?</a></li><li><a href=#nice-but-whats-about-the-alive-robot>Nice but What’s About the Alive Robot?</a></li><li><a href=#links>Links</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=https://blog.agramakov.me>main page</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://agramakov.me target=_blank><span>About me</span></a></li><li><a href=https://github.com/an-dr/blog_technical target=_blank><span>blog_technical@github</span></a></li><li><a href=https://zakhar.agramakov.me target=_blank><span>Zakhar on hackaday.io</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/aliveos/>aliveos</a></span>
<span><a href=/tags/articles/>articles</a></span>
<span><a href=/tags/build/>build</a></span>
<span><a href=/tags/canbus/>canbus</a></span>
<span><a href=/tags/cpp/>cpp</a></span>
<span><a href=/tags/display/>display</a></span>
<span><a href=/tags/diy/>diy</a></span>
<span><a href=/tags/eclipse/>eclipse</a></span>
<span><a href=/tags/embedded/>embedded</a></span>
<span><a href=/tags/emotions/>emotions</a></span>
<span><a href=/tags/hackaday/>hackaday</a></span>
<span><a href=/tags/hardware/>hardware</a></span>
<span><a href=/tags/howto/>howto</a></span>
<span><a href=/tags/i2c/>i2c</a></span>
<span><a href=/tags/interface/>interface</a></span>
<span><a href=/tags/linux/>linux</a></span>
<span><a href=/tags/mechanics/>mechanics</a></span>
<span><a href=/tags/motors/>motors</a></span>
<span><a href=/tags/opencv/>opencv</a></span>
<span><a href=/tags/protocol/>protocol</a></span>
<span><a href=/tags/prototyping/>prototyping</a></span>
<span><a href=/tags/raspberry/>raspberry</a></span>
<span><a href=/tags/research/>research</a></span>
<span><a href=/tags/robot/>robot</a></span>
<span><a href=/tags/robotics/>robotics</a></span>
<span><a href=/tags/ros/>ros</a></span>
<span><a href=/tags/stm32/>stm32</a></span>
<span><a href=/tags/uart/>uart</a></span>
<span><a href=/tags/visualstudio/>visualstudio</a></span>
<span><a href=/tags/zakhar/>zakhar</a></span>
<span><a href=/tags/zeromq/>zeromq</a></span>
<span><a href=/tags/zmq/>zmq</a></span></div></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank>CC BY-SA 4.0</a>.</p><span>&copy; 2022
<a href=https://blog.agramakov.me>Andrei Gramakov</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=/assets/js/fuji.min.js></script></body></html>